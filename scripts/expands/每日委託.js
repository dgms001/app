var jsts = "#fEffect/ItemEff/1102376/effect/proneStab/7#"; //橘色翅膀
var a11 = "#fUI/UIPVP.img/MiniMapIcon/star#"; //黃星星
var xxx = "#fEffect/CharacterEff/1032054/0/0#"; //選項兩邊
var SR3 = "#fUI/AllianceUI.img/AllianceUI/gradeIcon/5/icon#"; //最上面的
var XD0 = "#fEffect/CharacterEff/1051366/0/0#";

var p9 = "#fMap/MapHelper.img/weather/knitsWithWarmWinter/8#";
var zx50 = "#fMap/MapHelper.img/weather/lovelypartybear/7#";
var qq1 = "#fUI/EventShop/adventureShop/GradeBuyer/0#"
var qq2 = "#fUI/EventShop/adventureShop/GradeBuyer/1#"
var qq3 = "#fUI/EventShop/adventureShop/GradeBuyer/2#"
var qq4 = "#fUI/EventShop/adventureShop/GradeBuyer/3#"
var qq5 = "#fUI/EventShop/adventureShop/GradeBuyer/4#"
var qq6 = "#fUI/EventShop/adventureShop/GradeBuyer/5#"
var Icon = [
	Array("星星", "#fEtc/ChatEmoticon/expression/1/0#"),
	Array("彩虹", "#fEffect/ItemEff/1102877/effect/default/0#"),
	Array("猫咪", "#fUI/NameTag/190/w#"),
	Array("猫咪", "#fUI/NameTag/190/c#"),
	Array("猫咪", "#fUI/NameTag/190/e#"),
	Array("兔子", "#fEffect/CharacterEff/1112960/0/1#"),
	Array("星空", "#fUI/GuildMark/BackGround/00001013/16#"),
	Array("骷髅", "#fUI/GuildMark/Mark/Etc/00009000/15#"),
	Array("红心", "#fUI/GuildMark/Mark/Etc/00009001/1#"),
	Array("白脸", "#fUI/GuildMark/Mark/Etc/00009002/4#"),
	Array("皇冠", "#fUI/GuildMark/Mark/Etc/00009004/3#"),
	Array("红灯", "#fUI/GuildMark/Mark/Etc/00009020/1#"),
	Array("王冠", "#fUI/GuildMark/Mark/Etc/00009023/11#"),
	Array("水滴", "#fEffect/BasicEff/MainNotice/Gamsper/Notify/4#"),
	Array("红旗", "#fEffect/BasicEff/MainNotice/BlockBuster/Default/3#"),
	Array("红心", "#fEffect/CharacterEff/1112905/0/0#"),
	Array("云朵", "#fEffect/ItemEff/1102877/effect/default/1#"),
	Array("翅膀", "#fEffect/ItemEff/1102874/effect/ladder/0#"),
	Array("箭矢", "#fEffect/ItemEff/1112003/0/2#"),
	Array("黄鸭", "#fEffect/ItemEff/1004122/effect/default/8#"),
	Array("红点", "#fEffect/CharacterEff/1082588/0/0#"), //红点
	Array("蓝点", "#fEffect/CharacterEff/1082588/3/0#"),  //蓝点
	Array("黄星", "#fEffect/CharacterEff/1112924/0/0#"), //黄星
	Array("蓝星", "#fEffect/CharacterEff/1112925/0/0#"), //蓝星
	Array("红星", "#fEffect/CharacterEff/1112926/0/0#"), //红星
	Array("黄星星", "#fUI/UIPVP.img/MiniMapIcon/star#"),  //黄星星
	Array("星星", "#fEtc/ChatEmoticon/expression/1/0#"),
	Array("兔子", "#fEffect/CharacterEff/1112960/0/1#"),
	Array("星空", "#fUI/GuildMark/BackGround/00001013/16#"),
	Array("骷髅", "#fUI/GuildMark/Mark/Etc/00009000/15#"),
	Array("红心", "#fUI/GuildMark/Mark/Etc/00009001/1#"),
	Array("白脸", "#fUI/GuildMark/Mark/Etc/00009002/4#"),
	Array("皇冠", "#fUI/GuildMark/Mark/Etc/00009004/3#"),
	Array("红灯", "#fUI/GuildMark/Mark/Etc/00009020/1#"),
	Array("王冠", "#fUI/GuildMark/Mark/Etc/00009023/11#"),
	Array("水滴", "#fEffect/BasicEff/MainNotice/Gamsper/Notify/4#"),
	Array("红旗", "#fEffect/BasicEff/MainNotice/BlockBuster/Default/3#"),
	Array("红心", "#fEffect/CharacterEff/1112905/0/0#"),
	Array("云朵", "#fEffect/ItemEff/1102877/effect/default/1#"),
	Array("翅膀", "#fEffect/ItemEff/1102874/effect/ladder/0#"),
	Array("箭矢", "#fEffect/ItemEff/1112003/0/2#"),
	Array("黄鸭", "#fEffect/ItemEff/1004122/effect/default/8#"),
	Array("王冠", "#fUI/GuildMark/Mark/Etc/00009023/10#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/2#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/3#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/4#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/5#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/6#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/7#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/8#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/9#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/10#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/11#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/12#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/13#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/14#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/15#"),
	Array("灯组", "#fUI/GuildMark/Mark/Etc/00009020/16#"),
	Array("条件", "#fUI/UIWindow2.img/Quest/quest_info/summary_icon/startcondition#"),
	Array("信封", "#fUI/GuildMark/BackGround/00001003/5#"),
	Array("信封", "#fUI/GuildMark/BackGround/00001003/12#"),
	Array("钻石", "#fUI/NameTag/medal/556/w#"),
	Array("钻石", "#fUI/NameTag/medal/556/c#"),
	Array("钻石", "#fUI/NameTag/medal/556/e#"),
	Array("三角", "#fUI/piggyBarMinigame/crunch/5#"),
	Array("蓝点", "#fUI/piggyBarMinigame/crunch/1#"),
	Array("女神", "#fUI/RunnerGame/RunnerGameUI/Effect/ItemEffect_Protect1/3#"),
	Array("拇指", "#fUI/NameTag/medal/10/w#"),
	Array("拇指", "#fUI/NameTag/medal/10/c#"),
	Array("拇指", "#fUI/NameTag/medal/10/e#"),
	Array("成功", "#fUI/UIWindowJP/inputDirectionBattleTrigger/input/0/dear/7#"),
	Array("失败", "#fUI/UIWindowJP/inputDirectionBattleTrigger/input/0/fail/7#"),
	Array("星星", "#fUI/UIWindowGL/FeedbackSystem/Star#"),
	Array("蓝星", "#fEffect/CharacterEff/1003393/1/0#"),
	Array("花朵", "#fEffect/CharacterEff/1050334/2/0#"),
	Array("蓝星", "#fEffect/CharacterEff/1003393/0/0#"),
	Array("淡星", "#fEffect/CharacterEff/moveRandomSprayEff/eunwol_seal/effect/0/2#"),
	Array("花朵", "#fEffect/CharacterEff/1051294/1/0#"),
	Array("花朵", "#fEffect/CharacterEff/1051296/1/0#"),
	Array("金菇", "#fUI/NameTag/medal/74/w#"),
	Array("金菇", "#fUI/NameTag/medal/74/c#"),
	Array("金菇", "#fUI/NameTag/medal/74/e#"),
	Array("蛋糕", "#fUI/NameTag/medal/758/w#"),
	Array("蛋糕", "#fUI/NameTag/medal/758/c#"),
	Array("蛋糕", "#fUI/NameTag/medal/758/e#"),
	Array("胡子", "#fUI/NameTag/124/w#"),
	Array("胡子", "#fUI/NameTag/124/c#"),
	Array("胡子", "#fUI/NameTag/124/e#"),
	Array("帽子", "#fUI/NameTag/nick/312/w#"),
	Array("帽子", "#fUI/NameTag/nick/312/c#"),
	Array("帽子", "#fUI/NameTag/nick/312/e#"),
	Array("圣诞", "#fUI/NameTag/medal/728/w#"),
	Array("圣诞", "#fUI/NameTag/medal/728/c#"),
	Array("圣诞", "#fUI/NameTag/medal/728/e#"),
	Array("红钻", "#fUI/UIWindowPL/DuoEvent/Maximum/DuoInfo/icon/GoodF/0#"),
	Array("王冠", "#fUI/NameTag/medal/468/w#"),
	Array("王冠", "#fUI/NameTag/medal/468/c#"),
	Array("王冠", "#fUI/NameTag/medal/468/e#"),
	Array("确认", "#fUI/CashShop.img/CSCoupon/BtOK/normal/0#"),
	Array("幽灵", "#fEffect/ItemEff/1004738/effect/ladder/0#"),
	Array("幽灵", "#fEffect/ItemEff/1004738/effect/default/7#"),
	Array("幽灵", "#fEffect/ItemEff/1004738/effect/walk1/3#"),
	Array("幽灵", "#fEffect/ItemEff/1004738/effect/jump/0#"),
	Array("音符", "#fEffect/ItemEff/1112811/0/0#"),
	Array("红心", "#fEffect/CharacterEff/1112905/0/0#"),
	Array("幽灵", "#fEffect/ItemEff/1004738/effect/default/0#"),
	Array("幽灵", "#fEffect/ItemEff/1004738/effect/default/1#"),
	Array("幽灵", "#fEffect/ItemEff/1004738/effect/default/2#"),
	Array("幽灵", "#fEffect/ItemEff/1004738/effect/default/3#"),
	Array("金左指标", "#fUI/UIWindow/MonsterBook/arrowLeft/normal/0#"),
	Array("金右指标", "#fUI/UIWindow/MonsterBook/arrowRight/normal/0#"),
	Array("简单", "#fEffect/ItemEff/1102877/effect/default/0#")

];
var text = "";
var questid = 100100;
var maxtimes = 31;
var playerid = 0;
var accepttimes = 0;
var questitemid = 0;
var questitemcs = 0;
var questitemcsmap = 0;
var hitemid = 0;
var hitemcs = 0;
var 一鍵完成獎勵 = [
	[1, 5000],//這裡給點券
	[2, 5000],//這裡給抵用
	[3, 25],//這裡給活躍
	[4001714, 1],//下面是 道具+數量 自己往下面加 最後一個不要逗號
	[2614071, 1],
	[5062500, 5],
	[5062009, 5],
	[5062024, 2],
	[5062009, 2]//下面是 道具+數量 自己往下面加 最後一個不要逗號
];
var questitems = Array(
	Array(4000232, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 240020000), // 半人馬的火花 - 火焰半人馬之力量的來源。
	Array(4000233, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 240020400), // 半人馬的凈水 - 寒冰半人馬之力量的來源。
	Array(4000234, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 240020100), // 半人馬的骨頭 - 暗黑半人馬之力量的來源。
	Array(4000034, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 103030000), //
	Array(4000002, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 120000400), //
	Array(4000763, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 120041800), //
	Array(4000004, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 101050200), //
	Array(4000016, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 104010100), //
	Array(4000000, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 104010100), //
	Array(4000114, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 220040200), //
	Array(4000622, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 120000400), //
	Array(4000095, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 221023200), //
	Array(4000112, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 220030200), //
	Array(4000672, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 100040300), //
	Array(4000039, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 102030100), //
	Array(4000013, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 101020406), //
	Array(4000758, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 120041300), //
	Array(4000753, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 120040300), //
	Array(4000010, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 101050200), //
	Array(4000006, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 103010000), //
	Array(4000033, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 103030200), //
	Array(4000023, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 101030201), //
	Array(4000012, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 100020000), //
	Array(4000003, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 102020000), //
	Array(4000265, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 240030300), //
	Array(4000230, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 240010100), //
	Array(4000238, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 240010800), //
	Array(4000159, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 230010200), //
	Array(4000182, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 230040100), //
	Array(4000167, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 230020000), //
	Array(4000153, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 200082300), //
	Array(4000052, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 211040200), //
	Array(4000057, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 211040000), //
	Array(4000053, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 211040800), //
	Array(4000054, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 211041000), //
	Array(4000069, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 211041300), //
	Array(4000095, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 221023200), //
	Array(4000127, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 221021700), //
	Array(4000099, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 221021400), //
	Array(4000106, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 220010500), //
	Array(4000112, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 220030200), //
	Array(4000646, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 271000100), //
	Array(4000647, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 271000200), //
	Array(4000648, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 271000210), //
	Array(4000643, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 271020100), //
	Array(4000831, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 273030300), //
	Array(4000829, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 273030000), //
	Array(4000826, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 273020000), //
	Array(4000832, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 273040000), //
	Array(4000834, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 273040300), //
	Array(4000836, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 273060300), //
	Array(4000651, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 271030200), //
	Array(4000652, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 271030300), //
	Array(4000653, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 271030400), //
	Array(4000654, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 271030500), //
	Array(4000655, 50, "點擊[ #r確定#b ]傳送當前任務地圖", 271030510) //
);
var mapId = 0;
playerid = player.getId();
var info = player.getQuestRecordEx(questid, "COUNT");
accepttimes = player.getEventValue("RINGQUSTION");
if (info == null || accepttimes <= 0) {
	info = player.updateQuestRecordEx(questid, "COUNT=1;DONE=0;AC=0;ITEM=0;REQ=0;ID=0");
}

text = "#fs21##e#r這裡是委託任務!!!\r\n";



text += "#fs16##b#e";
text += "#b可完成次數：#r" + (maxtimes - accepttimes) + " #b次\r\n\r\n";
text += "接取委託後,0點後清除記錄。\r\n#b";
text += "每日次獎勵:[#v4032053#*333,#v4001713#*50]\r\n";
text += "每完成10次獎勵:[#v5060032#*5,#v5060048#*2,#v5064400#*1]\r\n";
text += "#r放棄超過10次,會無法接取任務(目前放棄:" + player.getEventValue("跑環放棄任務") + "次)\r\n";


text += "";
text += "";
/*if(accepttimes<1){
	
text+="#L999# #r一鍵完成10環任務(僅限一次都沒接受過任務的)#k#l\r\n";
	
}*/
if (player.getLevel() < 99) {
	npc.say("連續跑環任務需要角色等級大於#r100#k級");
} else if (player.getEventValue("連續跑環") > 1) {
	npc.say("該帳號跑環任務已經做完請明天再來!");
} else if (player.getEventValue("跑環放棄任務") >= 10) {
	npc.say("放棄次數達10次!!");
} else {
	if (player.getQuestRecordEx(questid, "AC").equals("1")) { // 判斷是否接取了任務
		if (accepttimes < maxtimes) { // 判斷是否超過完成次數
			hitemid = parseInt(player.getQuestRecordEx(questid, "ITEM"));
			hitemcs = parseInt(player.getQuestRecordEx(questid, "REQ"));
			text += "\t\t#e當前第 #r" + Math.max(1, accepttimes) + "#k 環  收集 #r#z" + hitemid + "#*" + hitemcs + "#k 個#n\r\n\r\n";
			if (hitemcs <= player.getEventValue("倉庫" + hitemid)) { // 判斷是否滿足任務條件
				text += "#b#L5#完成任務(倉庫材料扣除)#l\r\n\r\n";
			}
			if (player.hasItem(hitemid, hitemcs)) {	// 判斷是否滿足任務條件
				text += "#b#L1#完成任務(背包材料扣除)#l\r\n";
			} else {
				text += "#e怎麼了？還沒找到我要的東西嗎？#n\r\n";
			}
			text += "#L4#傳送材料地圖#l\r\n";
			text += "#r#L2#放棄任務 (無法獲得任何獎勵，且會消耗一次任務次數)#l\r\n";
		} else {
			text += "#e該帳號委託任務已經做完請明天再來!#n\r\n";
		}
	} else {
		text += "\t\t\t #e#b#L3#接受任務#l\r\n";
	}
	//可以跑環的選項
	let selection = npc.askMenuA(text);
	if (selection == 0) { // 重新接受任務 初始化
		var questrandid = Math.floor(Math.random() * questitems.length);
		questitemid = questitems[questrandid][0]; // 任務道具ID
		questitemcs = questitems[questrandid][1];
		questitemcsmap = questitems[questrandid][3];

		text = "#e第#r" + (accepttimes + 1) + "#k次：#n\r\n\r\n請幫我找到#b" + questitemcs + "#k個#r#z" + questitemid + "##k\r\n" + questitems[questrandid][3] + "\r\n#k感激不盡，快去快回~";
		// 重新接受任務
		player.updateQuestRecordEx(questid, "AC", "1");
		player.updateQuestRecordEx(questid, "DONE", "0");
		// 寫入任務道具ID
		player.updateQuestRecordEx(questid, "ITEM", questitemid + "");
		// 寫入任務道具數量
		player.updateQuestRecordEx(questid, "REQ", questitemcs + "");
		//寫入任務地圖
		player.updateQuestRecordEx(questid, "MAP", questitemcsmap + "");
		npc.say(text);
	} else if (selection == 1) { // 完成任務
		var doneCount = accepttimes + 1;
		//完成任務
		player.updateQuestRecordEx(questid, "DONE", "1");
		player.updateQuestRecordEx(questid, "AC", "0");
		player.updateQuestRecordEx(questid, "COUNT", doneCount + "");
		//經驗值獎勵
		var baseExp = 0.02;
		if (player.getLevel() < 110) {
			baseExp = 3500000;
		} else if (player.getLevel() < 120) {
			baseExp = 6400000;
		} else if (player.getLevel() < 130) {
			baseExp = 12000000;
		} else if (player.getLevel() < 140) {
			baseExp = 22000000;
		} else if (player.getLevel() < 150) {
			baseExp = 41000000;
		} else if (player.getLevel() < 160) {
			baseExp = 75000000;
		} else if (player.getLevel() < 170) {
			baseExp = 125000000;
		} else if (player.getLevel() < 180) {
			baseExp = 200000000;
		} else if (player.getLevel() < 190) {
			baseExp = 300000000;
		} else if (player.getLevel() < 200) {
			baseExp = 500000000;
		} else if (player.getLevel() < 300) {
			baseExp = 1500000000;
		}

		if (!(accepttimes % 10)) {
			if (player.getEventValue("RINGQUSTION") <= maxtimes) {
				player.gainItem(5060032, 5);//
				player.gainItem(5064400, 1);//
				player.gainItem(5060048, 2);//
				//player.modifyCashShopCurrency(1, 200);//樂豆
				addvalue(500);
			}
		} else {
			if (player.getEventValue("RINGQUSTION") <= maxtimes) {
				player.gainItem(4032053, 333);//黃金楓葉水晶
				player.gainItem(4001713, 50);//定居金
				//player.modifyCashShopCurrency(2, 1000);
				//player.modifyCashShopCurrency(1, 400);
			}
		}
		var calcExp = baseExp;
		if (calcExp >= 2147483647) {
			//計算分成幾次
			expNum = Math.floor((calcExp / 2147483647));
			//計算余數
			lastExp = Math.floor((calcExp % 2147483647));
			//根據計算次數多次給予經驗
			for (var i = 0; i < expNum; i++) {
				player.gainExp(2147483647);
			}
			//給予余數經驗
			player.gainExp(lastExp);
		} else {
			player.gainExp(calcExp);
		}
		player.loseItem(hitemid, hitemcs);
		text = "恭喜您完成了任務~~";
		player.updateQuestRecordEx(questid, ""); //大老叫我加的
		if (doneCount == 31) {
			npc.broadcastPlayerNotice(2, "[委託任務]" + "  " + "恭喜玩家【" + player.getName() + "】,完成了【第" + accepttimes + "次】任務獲得了豐厚的獎勵。");
		}
		npc.say(text);
		if (doneCount >= maxtimes) {
			player.addEventValue("連續跑環", 1, 1);
			text = "您已經完成了今天的任務，請明天0點後再來吧~";
		}

	} else if (selection == 2) { // 放棄任務
		var doneCount = accepttimes + 1;
		//完成任務
		player.updateQuestRecordEx(questid, "DONE", "0");
		player.updateQuestRecordEx(questid, "AC", "0");
		player.updateQuestRecordEx(questid, "COUNT", doneCount + "");
		player.updateQuestRecordEx(100101, (player.getEventValue("跑環放棄任務") + 1), accepttimes);//第幾次放棄了第幾環
		text = "任務已放棄……";
		player.updateQuestRecordEx(questid, "");
		player.addEventValue("跑環放棄任務", 1, 1);
		if (doneCount >= maxtimes) {
			player.addEventValue("連續跑環", 1, 1);
		}
		npc.say(text);

	} else if (selection == 3) { // 接受任務
		var questrandid = Math.floor(Math.random() * questitems.length);
		questitemid = questitems[questrandid][0]; // 任務道具ID
		questitemcsmap = questitems[questrandid][3];
		if (questitems[questrandid][1] < 0) {
			questitemcs = Math.floor(Math.random() * 20 * player.getLevel() / 10) + 30 + Math.floor(Math.random()); // 任務道具數量
		} else {
			questitemcs = questitems[questrandid][1];
		}
		text = "#e第#r" + (accepttimes + 1) + "#k次：#n\r\n\r\n請幫我收集#b" + questitemcs + "#k個#r#v" + questitemid + "##z" + questitemid + "#\r\n\r\n";
		player.updateQuestRecordEx(questid, "AC", "1");
		player.updateQuestRecordEx(questid, "DONE", "0");
		// 寫入任務道具ID
		player.updateQuestRecordEx(questid, "ITEM", questitemid + "");
		// 寫入任務道具數量
		player.updateQuestRecordEx(questid, "REQ", questitemcs + "");
		//寫入任務地圖
		player.updateQuestRecordEx(questid, "MAP", questitemcsmap + "");
		player.addEventValue("RINGQUSTION", 1, 1);
		let sel = npc.askMenuS(text + "\r\n #r#b#L0#傳送到材料地圖#l \r\n #k");//#L1#直接提交材料#l
		mapId = questitems[questrandid][3];

		if (sel == 0) {
			player.changeMap(mapId);
		} else {
			player.runScript("每日委託");

		}
	} else if (selection == 4) {
		mapId = parseInt(player.getQuestRecordEx(questid, "MAP"));
		player.changeMap(mapId);
	} else if (selection == 5) { // 完成任務
		var doneCount = accepttimes + 1;
		//完成任務
		player.updateQuestRecordEx(questid, "DONE", "1");
		player.updateQuestRecordEx(questid, "AC", "0");
		player.updateQuestRecordEx(questid, "COUNT", doneCount + "");
		//經驗值獎勵
		var baseExp = 0.02;
		if (player.getLevel() < 110) {
			baseExp = 3500000;
		} else if (player.getLevel() < 120) {
			baseExp = 6400000;
		} else if (player.getLevel() < 130) {
			baseExp = 12000000;
		} else if (player.getLevel() < 140) {
			baseExp = 22000000;
		} else if (player.getLevel() < 150) {
			baseExp = 41000000;
		} else if (player.getLevel() < 160) {
			baseExp = 75000000;
		} else if (player.getLevel() < 170) {
			baseExp = 125000000;
		} else if (player.getLevel() < 180) {
			baseExp = 200000000;
		} else if (player.getLevel() < 190) {
			baseExp = 300000000;
		} else if (player.getLevel() < 200) {
			baseExp = 500000000;
		} else if (player.getLevel() < 300) {
			baseExp = 1500000000;
		}

		if (!(accepttimes % 10)) {
			if (player.getEventValue("RINGQUSTION") <= maxtimes) {
				player.gainItem(5060032, 5);//
				player.gainItem(5064400, 1);//
				player.gainItem(5060048, 2);//
				//player.modifyCashShopCurrency(1, 200);//樂豆
				addvalue(500);
			}
		} else {
			if (player.getEventValue("RINGQUSTION") <= maxtimes) {
				player.gainItem(4032053, 333);//黃金楓葉水晶
				player.gainItem(4001713, 50);//定居金
				//player.modifyCashShopCurrency(2, 1000);
				//player.modifyCashShopCurrency(1, 400);
			}
		}
		var calcExp = baseExp;
		if (calcExp >= 2147483647) {
			//計算分成幾次
			expNum = Math.floor((calcExp / 2147483647));
			//計算余數
			lastExp = Math.floor((calcExp % 2147483647));
			//根據計算次數多次給予經驗
			for (var i = 0; i < expNum; i++) {
				player.gainExp(2147483647);
			}
			//給予余數經驗
			player.gainExp(lastExp);
		} else {
			player.gainExp(calcExp);
		}
		player.addEventValue("倉庫" + hitemid, -hitemcs, 999)
		text = "恭喜您完成了任務~~";
		player.updateQuestRecordEx(questid, ""); //大老叫我加的
		if (doneCount == 31) {
			npc.broadcastPlayerNotice(2, "[委託任務]" + "  " + "恭喜玩家【" + player.getName() + "】,完成了【第" + accepttimes + "次】任務獲得了豐厚的獎勵。");
		}
		npc.say(text);
		if (doneCount >= maxtimes) {
			player.addEventValue("連續跑環", 1, 1);
			text = "您已經完成了今天的任務，請明天0點後再來吧~";
		}
	} else if (selection == 999) {
		if (player.getEventValue("連續跑環") < 1) {
			if (player.hasItem(4000463, 20)) {
				player.loseItem(4000463, 25);
				player.addEventValue("連續跑環", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				player.addEventValue("RINGQUSTION", 1, 1);
				for (var i = 0; i < 一鍵完成獎勵.length; i++) {
					if (一鍵完成獎勵[i][0] == 1) {//點券
						player.modifyCashShopCurrency(1, 一鍵完成獎勵[i][1]);
					} else if (一鍵完成獎勵[i][0] == 2) {//抵用
						player.modifyCashShopCurrency(2, 一鍵完成獎勵[i][1]);
					} else if (一鍵完成獎勵[i][0] == 3) {//活躍
					} else {
						player.gainItem(一鍵完成獎勵[i][0], 一鍵完成獎勵[i][1]);
					}
				}
				npc.broadcastPlayerNotice(0x15, "『每日跑環』: 玩家 " + player.getName() + " 使用了一鍵完成所有跑環功能!");
			} else {
				npc.say("你需要#r20個國慶紀念幣##v4000463# ，可以在會員中心裡用余額兌換道具");
			}
		} else {
			npc.say("一天只能使用一次這個功能哦");
		}

	}

}


function getEventCount(eventName) {

	var sql = "select value,time from accounts_event where accounts_id = ? and event =? ";

	var result = player.customSqlResult(sql, player.getAccountId(), eventName);

	if (result.size() > 0) {
		if (result.get(0) != null) {
			return result.get(0).get("value");
		}
	} else {
		var sql = "insert into  accounts_event (accounts_id,world,event,type,value) values(?,?,?,?,?)";

		var result = player.customSqlInsert(sql, player.getAccountId(), player.getWorld(), eventName, 0, 0);
		return 0;
	}

}

function setEventCount(eventName, type, value) {

	var sql = "update accounts_event set type=?,value=value+? where accounts_id=? and event=?";

	var result = player.customSqlUpdate(sql, type, value, player.getAccountId(), eventName);


}

function getHyPay() {

	var sql = "select pay from hypay where accountid = ? ";

	var result = player.customSqlResult(sql, player.getAccountId());

	if (result.size() > 0) {
		if (result.get(0) != null) {
			return result.get(0).get("pay");
		}
	} else {
		return 0;
	}

}

function addvalue(level) { //給予經驗值
	var sql = "update dgms_zhanling set value=value+? where name=?";
	player.customSqlUpdate(sql, level, "" + getAccountName() + "");

}

function getAccountName() {
	var sql = "select name from characters where id=  " + player.getId() + " ";
	var resultList = player.customSqlResult(sql);
	var accountName = 0;
	for (var i = 0; i < resultList.size(); i++) {
		var result = resultList.get(i);
		if (result == null) {
			break;
		}
		accountName = result.get("name");
	}
	return accountName;
}